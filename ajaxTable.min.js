const _ajaxTable=[];!function($){$.fn.extend({ajaxTable:function(options){this.defaultOptions={source:!1,sourceContext:{},printButtons:!0,orderBy:0,orderSort:"desc",logging:!1,onReady:function(table,data){},beforeAjax:function(table,data){},onUpdate:function(table,data){}};let settings=$.extend({},this.defaultOptions,options),lang=window.navigator.userLanguage||window.navigator.language;function mergeSort(array,comparefn){function merge(arr,aux,lo,mid,hi,comparefn){for(var i=lo,j=mid+1,k=lo;;){var cmp;if(comparefn(arr[i],arr[j])<=0){if(aux[k++]=arr[i++],i>mid){do{aux[k++]=arr[j++]}while(j<=hi);break}}else if(aux[k++]=arr[j++],j>hi){do{aux[k++]=arr[i++]}while(i<=mid);break}}}function sortarrtoaux(arr,aux,lo,hi,comparefn){if(!(hi<lo))if(hi!=lo){var mid=Math.floor(lo+(hi-lo)/2);sortarrtoarr(arr,aux,lo,mid,comparefn),sortarrtoarr(arr,aux,mid+1,hi,comparefn),merge(arr,aux,lo,mid,hi,comparefn)}else aux[lo]=arr[lo]}function sortarrtoarr(arr,aux,lo,hi,comparefn){if(!(hi<=lo)){var mid=Math.floor(lo+(hi-lo)/2);sortarrtoaux(arr,aux,lo,mid,comparefn),sortarrtoaux(arr,aux,mid+1,hi,comparefn),merge(aux,arr,lo,mid,hi,comparefn)}}function merge_sort(arr,comparefn){var aux;return sortarrtoarr(arr,arr.slice(0),0,arr.length-1,comparefn),arr}return merge_sort(array,comparefn)}function htmlToElement(html){var template=document.createElement("template");return html=html.trim(),template.innerHTML=html,template.content.firstChild}function paginationDisplay(currentPage,pageCount){let delta=2,left=currentPage-2,right=currentPage+2+1,result=[];return(result=Array.from({length:pageCount},(v,k)=>k+1).filter(i=>i&&i>=left&&i<right)).length>1&&(result[0]>1&&(result[0]>2&&result.unshift("..."),result.unshift(1)),result[result.length-1]<pageCount&&(result[result.length-1]!==pageCount-1&&result.push("..."),result.push(pageCount))),result}function updateNav(utilities,targetedPage,pageCount,i){for(li of($(".pagination-page,.pagination-etc",utilities).remove(),1!=targetedPage?$(".pagination-prev",utilities).removeClass("disabled"):$(".pagination-prev",utilities).addClass("disabled"),targetedPage<pageCount?$(".pagination-next",utilities).removeClass("disabled"):$(".pagination-next",utilities).addClass("disabled"),paginationDisplay(_ajaxTable[i].page,pageCount)))$(".pagination-next",utilities).before('<li class="'+("..."==li?"pagination-etc":"pagination-page")+(li==targetedPage?" active":"")+'" data-page="'+li+'">'+li+"</li>");_ajaxTable[i].page=targetedPage,$("#ajax-table-item-start-id",utilities).text(10*(_ajaxTable[i].page-1)+1>_ajaxTable[i].filteredTotal?_ajaxTable[i].filteredTotal:10*(_ajaxTable[i].page-1)+1),$("#ajax-table-item-end-id",utilities).text(10*_ajaxTable[i].page>_ajaxTable[i].filteredTotal?_ajaxTable[i].filteredTotal:10*_ajaxTable[i].page),$("#ajax-table-item-filtered-total",utilities).text(_ajaxTable[i].filteredTotal),$("#ajax-table-item-total",utilities).text(_ajaxTable[i].total)}function updateTable(table,i){$("tbody",table).empty().append(_ajaxTable[i].filteredData.slice(10*(_ajaxTable[i].page-1),10*_ajaxTable[i].page)),_ajaxTable[i].filteredData.slice(10*(_ajaxTable[i].page-1),10*_ajaxTable[i].page).length||$("tbody",table).append('<tr><td class="empty" colspan="'+_ajaxTable[i].columns+'">'+(lang.toLowerCase().includes("fr")?"Aucune donnée disponible dans le tableau":"No data available")+"</td></tr>");let pageCount=Math.floor((_ajaxTable[i].filteredTotal-1)/10)+1;updateNav($(table).next(),_ajaxTable[i].page,pageCount,i)}function paginationHandler(table,i,targetedPage,pagination,pageCount){let dataGathering;new Promise((resolve,reject)=>{!settings.source||_ajaxTable[i].dataFullyLoaded||(_ajaxTable[i].activeSearch||_ajaxTable[i].silentData[targetedPage])&&!_ajaxTable[i].activeSearch?settings.source&&!_ajaxTable[i].dataFullyLoaded&&_ajaxTable[i].silentData[targetedPage]?($("tbody",table).empty().append(_ajaxTable[i].silentData[targetedPage]),_ajaxTable[i].silentData[targetedPage].length||$("tbody",table).append('<tr><td class="empty" colspan="'+_ajaxTable[i].columns+'">'+(lang.toLowerCase().includes("fr")?"Aucune donnée disponible dans le tableau":"No data available")+"</td></tr>"),resolve(_ajaxTable[i].total)):($("tbody",table).empty().append(_ajaxTable[i].filteredData.slice(10*(targetedPage-1),10*targetedPage)),_ajaxTable[i].filteredData.slice(10*(targetedPage-1),10*targetedPage).length||$("tbody",table).append('<tr><td class="empty" colspan="'+_ajaxTable[i].columns+'">'+(lang.toLowerCase().includes("fr")?"Aucune donnée disponible dans le tableau":"No data available")+"</td></tr>"),resolve(_ajaxTable[i].filteredData.length)):(settings.beforeAjax.call(void 0,table,_ajaxTable[i]),settings.logging&&console.log("ajaxTable calling source..."),LOADER.enable(),$.post(settings.source,{page:targetedPage,orderBy:_ajaxTable[i].orderBy,order:_ajaxTable[i].orderSort,search:_ajaxTable[i].search,searchPatterns:_ajaxTable[i].searchPatterns,columns:_ajaxTable[i].columns,total:!0,context:settings.sourceContext},()=>{},"json").done(json=>{for(tr of($("tbody",table).empty(),json.data))$("tbody",table).append(tr);json.data.length||$("tbody",table).append('<tr><td class="empty" colspan="'+_ajaxTable[i].columns+'">'+(lang.toLowerCase().includes("fr")?"Aucune donnée disponible dans le tableau":"No data available")+"</td></tr>"),_ajaxTable[i].activeSearch||_ajaxTable[i].orderBy!=settings.orderBy||_ajaxTable[i].orderSort!=settings.orderSort?settings.logging&&console.log("ajaxTable temporally recieved "+json.data.length+" items."):(_ajaxTable[i].silentData[""+targetedPage]=json.data.map(e=>htmlToElement(e)),settings.logging&&console.log("ajaxTable recieved "+json.data.length+" items.")),LOADER.disable(),resolve(json.total)}).fail((_,textStatus,error)=>{let err="Request Failed: "+textStatus+", "+error;console.log(_),console.log(err),LOADER.disable(),reject(err)}))}).then(items=>{_ajaxTable[i].page=targetedPage,updateNav(pagination.parent(),targetedPage,Math.floor((items-1)/10)+1,i),settings.onUpdate.call(void 0,table,_ajaxTable[i])}).catch(err=>{alert(err)})}function silentLoad(page,i,table){settings.beforeAjax.call(void 0,table,_ajaxTable[i]),settings.logging&&console.log("ajaxTable calling source..."),$.post(settings.source,{page:page,context:settings.sourceContext},()=>{},"json").done(json=>{_ajaxTable[i].silentData[""+page]=json.data.map(e=>htmlToElement(e)),settings.logging&&console.log("ajaxTable silently recieved "+json.data.length+" items. (page "+page+")"),page<Math.floor((_ajaxTable[i].total-1)/10)+1?silentLoad(page+1,i):(_ajaxTable[i].dataFullyLoaded=!0,_ajaxTable[i].data=[].concat(...Object.values(_ajaxTable[i].silentData)),_ajaxTable[i].filteredData=_ajaxTable[i].data,$("tfoot input",table).filter((_,e)=>e.value).each(function(){let index=$(this).parent().index();_ajaxTable[i].filteredData=_ajaxTable[i].filteredData.filter(tr=>tr.childNodes[index].hasAttribute("data-search")&&tr.childNodes[index].attr("data-search").toLowerCase().includes(this.value.toLowerCase())||tr.childNodes[index].innerText.toLowerCase().includes(this.value))}),_ajaxTable[i].total=_ajaxTable[i].data.length,_ajaxTable[i].filteredTotal=_ajaxTable[i].filteredData.length,settings.logging&&console.log("ajaxTable is done with AJAX tasks."))}).fail((_,textStatus,error)=>{let err="Request Failed: "+textStatus+", "+error;console.log(_),console.log(err),silentLoad(page,i)})}function saveState(i){localStorage.setItem(window.location.hostname+window.location.pathname+"_ajaxTable_"+i+"_search",JSON.stringify(_ajaxTable[i].search)),localStorage.setItem(window.location.hostname+window.location.pathname+"_ajaxTable_"+i+"_orderBy",JSON.stringify(_ajaxTable[i].orderBy)),localStorage.setItem(window.location.hostname+window.location.pathname+"_ajaxTable_"+i+"_order",JSON.stringify(_ajaxTable[i].orderSort)),localStorage.setItem(window.location.hostname+window.location.pathname+"_ajaxTable_"+i+"_expires",(new Date).getTime()+36e5)}return this.each(function(i){let that=this;$(this).addClass("ajax-table-processed");let bundle={orderBy:settings.orderBy,orderSort:settings.orderSort,search:[],activeSearch:!1,searchPatterns:[],columns:$("thead th",that).length,page:1,total:1,filteredTotal:1,printButtons:settings.printButtons,data:[],filteredData:[],silentData:{},dataFullyLoaded:!1},dataReady;bundle.data=$("tbody>tr",this).get(),bundle.filteredData=[...bundle.data],$("tfoot",this).length||$(this).append("<tfoot><tr></tr></tfoot>"),$("tfoot",this).insertAfter($("thead",this)),$("tfoot tr",this).empty(),$("thead th",this).each(function(){$("tfoot tr",that).append('<td><input type="text" placeholder="'+(lang.toLowerCase().includes("fr")?"Entrée pour chercher":"Enter to search")+'"></td>')}),bundle.search=$("tfoot input",that).get().map(e=>e.value),bundle.data.length>10&&$("tbody>tr:nth-of-type(n+11)",this).remove(),new Promise((resolve,reject)=>{settings.source?(settings.beforeAjax.call(void 0,that,bundle),settings.logging&&console.log("ajaxTable calling source..."),LOADER.enable(),$.post(settings.source,{total:!0,context:settings.sourceContext},()=>{},"json").done(json=>{for(tr of($("tbody",this).empty(),json.data))$("tbody",this).append(tr);json.data.length||$("tbody",this).append('<tr><td class="empty" colspan="'+bundle.columns+'">'+(lang.toLowerCase().includes("fr")?"Aucune donnée disponible dans le tableau":"No data available")+"</td></tr>"),bundle.data=json.data.map(e=>htmlToElement(e)),bundle.filteredData=[...bundle.data],bundle.silentData[1]=[...bundle.data],bundle.total=json.total,bundle.filteredTotal=json.total,bundle.searchPatterns=$("tbody tr:nth-of-type(1) td",that).get().map(e=>e.getAttribute("data-search-template")),settings.logging&&console.log("ajaxTable recieved "+json.data.length+" items."),LOADER.disable(),resolve()}).fail((_,textStatus,error)=>{let err="Request Failed: "+textStatus+", "+error;console.log(_),console.log(err),LOADER.disable(),reject(err)})):(bundle.total=bundle.data.length,bundle.filteredTotal=bundle.filteredData.length,resolve())}).then(_=>{_ajaxTable.push(bundle),i=_ajaxTable.length-1;let orderedColumn=$("thead th",that).eq(_ajaxTable[i].orderBy);orderedColumn.addClass("sorted"),"asc"==_ajaxTable[i].orderSort&&orderedColumn.addClass("inverted");let pagination=$('<aside class="ajax-table-pagination"><ul><li class="pagination-prev disabled">&laquo;</li><li class="pagination-next">&raquo;</li></ul></aside>'),pageCount=Math.floor((_ajaxTable[i].total-1)/10)+1,count=$('<aside class="ajax-table-count"><div>'+(lang.toLowerCase().includes("fr")?"Elements":"Items")+' <span id="ajax-table-item-start-id"></span> '+(lang.toLowerCase().includes("fr")?"à":"to")+' <span id="ajax-table-item-end-id"></span> '+(lang.toLowerCase().includes("fr")?"sur":"of")+' <span id="ajax-table-item-filtered-total"></span> (<span id="ajax-table-item-total"></span> '+(lang.toLowerCase().includes("fr")?"au total":"total")+")</div></aside>"),utilities=$('<div class="ajax-table-utilities"></div>');settings.printButtons&&utilities.append('<aside class="ajax-table-buttons"><ul><li class="export">Excel</li><li class="export">CSV</li><li class="export">PDF</li></ul></aside>'),utilities.append(count),utilities.append(pagination),$(this).after(utilities),updateNav(utilities,1,pageCount,i),pagination.on("click","li.pagination-page:not(.active)",function(){let targetedPage=+$(this).attr("data-page");paginationHandler(that,i,targetedPage,pagination,pageCount)}),pagination.on("click","li.pagination-prev:not(.disabled),li.pagination-next:not(.disabled)",function(){let targetedPage=+$(this).siblings(".active").attr("data-page");$(this).is(".pagination-prev")?targetedPage--:targetedPage++,paginationHandler(that,i,targetedPage,pagination,pageCount)}),settings.printButtons&&utilities.on("click",".ajax-table-buttons li",function(){switch($(this).index()){case 0:$(that).excelExport();break;case 1:let tableToPrint=$(that).clone();$("tfoot",tableToPrint).remove(),tableToPrint.csvExport();break;case 2:let iframe=$('<iframe class="excel-export" style="visibility: hidden; position: absolute; top:0; right:0;"></iframe>').appendTo("body");tableToPDF=$(that).clone(),$("tfoot",tableToPDF).remove(),iframe.contents().find("body").append(tableToPDF),iframe.contents().find("head").append('<link rel="stylesheet" href="https://rawgit.com/Zenoo/ajaxTable/master/ajaxTable.css">'),iframe[0].contentWindow.print(),iframe.remove()}}),$("thead th",this).on("click",function(){$(this).is(".sorted")?$(this).toggleClass("inverted"):$(this).addClass("sorted").siblings().removeClass("sorted inverted");let order=$(this).hasClass("inverted")?1:-1,sortingPromise;_ajaxTable[i].orderBy=$(this).index(),_ajaxTable[i].orderSort=1==order?"asc":"desc",_ajaxTable[i].page=1,new Promise((resolve,reject)=>{if(settings.source&&!_ajaxTable[i].dataFullyLoaded)settings.beforeAjax.call(void 0,that,_ajaxTable[i]),settings.logging&&console.log("ajaxTable calling source..."),LOADER.enable(),$.post(settings.source,{page:_ajaxTable[i].page,orderBy:_ajaxTable[i].orderBy,order:_ajaxTable[i].orderSort,search:_ajaxTable[i].search,searchPatterns:_ajaxTable[i].searchPatterns,columns:_ajaxTable[i].columns,context:settings.sourceContext},()=>{},"json").done(json=>{for(tr of($("tbody",that).empty(),json.data))$("tbody",that).append(tr);json.data.length||$("tbody",that).append('<tr><td class="empty" colspan="'+_ajaxTable[i].columns+'">'+(lang.toLowerCase().includes("fr")?"Aucune donnée disponible dans le tableau":"No data available")+"</td></tr>"),settings.logging&&console.log("ajaxTable temporally recieved "+json.data.length+" items."),updateNav(utilities,1,pageCount,i),LOADER.disable(),resolve()}).fail((_,textStatus,error)=>{let err="Request Failed: "+textStatus+", "+error;console.log(_),console.log(err),LOADER.disable(),reject(err)});else{let index=$(this).index();_ajaxTable[i].filteredData=mergeSort(_ajaxTable[i].filteredData,(a,b)=>{let $a_dataOrder=a.childNodes[index].getAttribute("data-order"),$b_dataOrder=b.childNodes[index].getAttribute("data-order"),$a_text=a.childNodes[index].innerText,$b_text=b.childNodes[index].innerText;return a.childNodes[index].hasAttribute("data-order")?isNaN($a_dataOrder)?$a_dataOrder.localeCompare($b_dataOrder)*order:+$a_dataOrder>+$b_dataOrder?order:+$a_dataOrder==+$b_dataOrder?0:-order:isNaN($a_text)?$a_text.localeCompare($b_text)*order:+$a_text>+$b_text?order:+$a_text==+$b_text?0:-order}),updateTable(that,i),resolve()}}).then(()=>{saveState(i),settings.onUpdate.call(void 0,that,_ajaxTable[i])}).catch(error=>{alert(error)})}),$("tfoot input",this).on("keyup blur",function(e){if(13==e.keyCode||"blur"==e.type&&this.value!=_ajaxTable[i].search[$(this).parent().index()]){let searchPromise;_ajaxTable[i].search[$(this).parent().index()]=this.value,_ajaxTable[i].activeSearch=!!_ajaxTable[i].search.filter(e=>e.length).length,_ajaxTable[i].page=1,new Promise((resolve,reject)=>{settings.source&&!_ajaxTable[i].dataFullyLoaded?(settings.beforeAjax.call(void 0,that,_ajaxTable[i]),settings.logging&&console.log("ajaxTable calling source..."),LOADER.enable(),$.post(settings.source,{page:_ajaxTable[i].page,orderBy:_ajaxTable[i].orderBy,order:_ajaxTable[i].orderSort,search:_ajaxTable[i].search,searchPatterns:_ajaxTable[i].searchPatterns,columns:_ajaxTable[i].columns,total:!0,context:settings.sourceContext},()=>{},"json").done(json=>{for(tr of($("tbody",that).empty(),json.data))$("tbody",that).append(tr);json.data.length||$("tbody",that).append('<tr><td class="empty" colspan="'+_ajaxTable[i].columns+'">'+(lang.toLowerCase().includes("fr")?"Aucune donnée disponible dans le tableau":"No data available")+"</td></tr>"),settings.logging&&console.log("ajaxTable temporally recieved "+json.data.length+" items."),_ajaxTable[i].filteredTotal=json.total,updateNav(utilities,_ajaxTable[i].page,Math.floor((json.total-1)/10)+1,i),LOADER.disable(),resolve()}).fail((_,textStatus,error)=>{let err="Request Failed: "+textStatus+", "+error;console.log(_),console.log(err),LOADER.disable(),reject(err)})):(_ajaxTable[i].filteredData=_ajaxTable[i].data,$("tfoot input",that).filter((_,e)=>e.value).each(function(){let index=$(this).parent().index();_ajaxTable[i].filteredData=_ajaxTable[i].filteredData.filter(tr=>tr.childNodes[index].hasAttribute("data-search")&&tr.childNodes[index].attr("data-search").toLowerCase().includes(this.value.toLowerCase())||tr.childNodes[index].innerText.toLowerCase().includes(this.value.toLowerCase()))}),_ajaxTable[i].filteredTotal=_ajaxTable[i].filteredData.length,updateTable(that,i),resolve())}).then(()=>{saveState(i),settings.onUpdate.call(void 0,that,_ajaxTable[i])}).catch(error=>{alert(error)})}}),settings.logging&&console.log("ajaxTable ready."),settings.onReady.call(void 0,that,_ajaxTable[i]),settings.onUpdate.call(void 0,that,_ajaxTable[i]);let storageExpiresAt=localStorage.getItem(window.location.hostname+window.location.pathname+"_ajaxTable_"+i+"_expires");if(storageExpiresAt)if((new Date).getTime()<storageExpiresAt){_ajaxTable[i].search=JSON.parse(localStorage.getItem(window.location.hostname+window.location.pathname+"_ajaxTable_"+i+"_search")),_ajaxTable[i].orderBy=+JSON.parse(localStorage.getItem(window.location.hostname+window.location.pathname+"_ajaxTable_"+i+"_orderBy")),_ajaxTable[i].orderSort=JSON.parse(localStorage.getItem(window.location.hostname+window.location.pathname+"_ajaxTable_"+i+"_order")),$("tfoot input",that).each(function(j){this.value=_ajaxTable[i].search[j]?_ajaxTable[i].search[j]:""}),_ajaxTable[i].activeSearch=!!_ajaxTable[i].search.filter(e=>e.length).length,$("thead th",that).removeClass("sorted inverted");let orderedColumn=$("thead th",that).eq(_ajaxTable[i].orderBy);orderedColumn.addClass("sorted"),"asc"==_ajaxTable[i].orderSort&&orderedColumn.addClass("inverted"),settings.source&&!_ajaxTable[i].dataFullyLoaded?(settings.beforeAjax.call(void 0,that,_ajaxTable[i]),settings.logging&&console.log("ajaxTable calling source..."),LOADER.enable(),DEF.log({page:_ajaxTable[i].page,orderBy:_ajaxTable[i].orderBy,order:_ajaxTable[i].orderSort,search:_ajaxTable[i].search,searchPatterns:_ajaxTable[i].searchPatterns,columns:_ajaxTable[i].columns,total:!0,context:settings.sourceContext}),$.post(settings.source,{page:_ajaxTable[i].page,orderBy:_ajaxTable[i].orderBy,order:_ajaxTable[i].orderSort,search:_ajaxTable[i].search,searchPatterns:_ajaxTable[i].searchPatterns,columns:_ajaxTable[i].columns,total:!0,context:settings.sourceContext},()=>{},"json").done(json=>{for(tr of($("tbody",that).empty(),json.data))$("tbody",that).append(tr);json.data.length||$("tbody",that).append('<tr><td class="empty" colspan="'+_ajaxTable[i].columns+'">'+(lang.toLowerCase().includes("fr")?"Aucune donnée disponible dans le tableau":"No data available")+"</td></tr>"),settings.logging&&console.log("ajaxTable temporally recieved "+json.data.length+" items."),_ajaxTable[i].page=1,_ajaxTable[i].filteredTotal=json.total,updateNav(utilities,_ajaxTable[i].page,Math.floor((json.total-1)/10)+1,i),LOADER.disable(),settings.onUpdate.call(void 0,that,_ajaxTable[i])}).fail((_,textStatus,error)=>{let err="Request Failed: "+textStatus+", "+error;console.log(_),console.log(err),LOADER.disable()})):(_ajaxTable[i].filteredData=_ajaxTable[i].data,_ajaxTable[i].page=1,$("tfoot input",that).filter((_,e)=>e.value).each(function(){let index=$(this).parent().index();_ajaxTable[i].filteredData=_ajaxTable[i].filteredData.filter(tr=>tr.childNodes[index].hasAttribute("data-search")&&tr.childNodes[index].attr("data-search").toLowerCase().includes(this.value.toLowerCase())||tr.childNodes[index].innerText.toLowerCase().includes(this.value))}),_ajaxTable[i].filteredTotal=_ajaxTable[i].filteredData.length,updateTable(that,i),settings.onUpdate.call(void 0,that,_ajaxTable[i]))}else localStorage.removeItem(window.location.hostname+window.location.pathname+"_ajaxTable_"+i+"_search"),localStorage.removeItem(window.location.hostname+window.location.pathname+"_ajaxTable_"+i+"_orderBy"),localStorage.removeItem(window.location.hostname+window.location.pathname+"_ajaxTable_"+i+"_order"),localStorage.removeItem(window.location.hostname+window.location.pathname+"_ajaxTable_"+i+"_expires"),storageExpiresAt=null;Math.floor((_ajaxTable[i].total-1)/10)+1>1&&settings.source?silentLoad(2,i):_ajaxTable[i].dataFullyLoaded=!0}).catch(err=>{alert(err)})}),this}})}(jQuery);